<!DOCTYPE html>
<html>
<head>
	<title>Simple Album</title>

	<base href="//polygit.org/components/">

	<script>
	  // Setup Polymer options
	  window.Polymer = {
		dom: 'shadow',
		lazyRegister: true
          };
	</script>
        <script src="webcomponentsjs/webcomponents-lite.min.js"></script>
	<link href="polymer/polymer.html" rel="import">
	<link href="app-route/app-location.html" rel="import">
	<link href="app-route/app-route.html" rel="import">
	<link href="iron-pages/iron-pages.html" rel="import">
	<link href="iron-ajax/iron-ajax.html" rel="import">

	<style>
		body {
			margin: 0;
			background-color: #222;
			font-family: -apple-system, BlinkMacSystemFont,
						 "Segoe UI", "Roboto", "Oxygen",
						 "Ubuntu", "Cantarell", "Fira Sans",
						 "Droid Sans", "Helvetica Neue", sans-serif;
		}

		body,
		a {
			color: #eee;
		}
	</style>
</head>
<body>

<!--   HOME-PAGE   -->

<dom-module id="home-page">
	<style>
		:host {
			display: flex;
			flex-flow: column nowrap;
			justify-content: center;
			align-items: center;

			min-height: 100vh;
			/*height: 100%;*/
		}

		:host .page {
			font-size: smaller;
			font-variant: small-caps;
		}
	</style>

	<template>
		<div class="page">
			<p>Enter album ID:</p>
			<input type="text" value="{{albumId::change}}">
		</div>
	</template>

	<script>
		addEventListener('WebComponentsReady', function() {
			Polymer({
				is: 'home-page',

				properties: {
					albumId: {
						type: String,
						reflectToAttribute: true,
						notify: true
					}
				}
			});
		});
	</script>
</dom-module>

<!--   ALBUM-PAGE   -->

<dom-module id="album-page">
	<style>
		:host {
			display: block;
			min-height: 100vh;
			/*height: 100%;*/
			max-width: 50em;
		}

		:host,
		:host a {
			color: #eee;
		}

		:host ul {
			list-style: none;
			padding: 0;
		}

		:host li {
			margin-top: 3em;
		}

		:host figure {
			margin: 0;
		}

		:host figure img {
			width: 100%;
		}

		:host figure figcaption {
			margin-top: 1em;
		}
	</style>

	<template>
		<h1><a href="[[link]]">[[title]]</a></h1>

		<ul>
			<template is="dom-repeat" items="[[images]]" as="image">
				<li>
					<figure>
						<img src="[[image.src]]">
						<figcaption>[[image.desc]]</figcaption>
					</figure>
				</li>
			</template>
		</ul>

		<iron-ajax id="albumRequest"
			url='https://api.imgur.com/3/album/[[albumId]]'
			headers='{"Authorization": "Client-ID 692228d9f298de4"}'
			handle-as="json"
			on-response='_generateAlbum'></iron-ajax>
	</template>

	<script>
		addEventListener('WebComponentsReady', function() {
			Polymer({
				is: 'album-page',

				properties: {
					albumId: {
						type: String,
						observer: '_albumChanged'
					},

					title: {
						type: String,
						notify: true
					},

					link: String,

					images: {
						type: Array,
						value: function() {
							return [];
						}
					}
				},

				_albumChanged: function(url) {
					this.$.albumRequest.generateRequest();
				},

				_generateAlbum: function() {
					var data = this.$.albumRequest.lastResponse.data;
					this.title = data.title;
					this.link = data.link;
					this.images = data.images.map(function(img) {
						return {
							src: img.link,
							desc: img.description
						}
					})
				}
			});
		});
	</script>
</dom-module>

<!--   SIMPLE-ALBUM   -->

<dom-module id="simple-album">
	<style>
		:host {
			display: block;
			min-height: 100vh;
			/*height: 100%;*/

			max-width: 50em;
			margin: 0 auto;
		}
	</style>

	<template>
		<app-location route="{{route}}" use-hash-as-path></app-location>
		<app-route route="{{route}}"
				   pattern="/:page"
				   data="{{routeData}}"
				   tail="{{subroute}}"></app-route>
		<app-route route="{{subroute}}"
				   pattern="/:albumId"
				   data="{{subrouteData}}"></app-route>

		<iron-pages selected="[[page]]"
					attr-for-selected="name"
					selected-attribute="visible">
			<home-page class="page" name="home" album-id="{{albumId}}" title="{{title}}"></home-page>
			<album-page class="page" name="album" album-id="[[albumId]]" title="{{title}}"></album-page>
		</iron-pages>
	</template>

	<script>
		addEventListener('WebComponentsReady', function() {
			Polymer({
				is: 'simple-album',

				properties: {
					page: {
						type: String,
						reflectToAttribute: true
						// observer: '_pageChanged'
					},

					albumId: {
						type: String,
						observer: '_albumChanged'
					},

					title: {
						type: String,
						value: 'Simple Album',
						observer: '_titleChanged'
					}
				},

				observers: [
					'_routePageChanged(routeData.page)',
					'_routePageChanged(routeData.page, subrouteData.albumId)'
				],

				_routePageChanged: function(page, albumId) {
					this.page = page || 'home';
					if (albumId) {
						this.albumId = albumId;
					}
				},

				// _pageChanged: function(page) {
				// 	// XXX anything to do ???
				// },

				_albumChanged: function() {
					this.set('route.path', '/album/' + this.albumId);
				},

				_titleChanged: function(title) {
					document.title = title;
				}
			});
		});
	</script>
</dom-module>

<simple-album></simple-album>

</body>
</html>
